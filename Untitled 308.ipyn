import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞
API_TOKEN = '7399727926:AAFrzdjj7svQVxlavXbPV7hXfXimq6krnoY'
bot = telebot.TeleBot(API_TOKEN)

# ID –∫–∞–Ω–∞–ª–∞, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
CHANNEL_ID = '@JetReport'

def send_violation_report(sender_id, sender_name, violator_id, violator_name, violation_reason, chat_username, chat_id, message_id):
    try:
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
        if chat_username:  # –ü—É–±–ª–∏—á–Ω—ã–π —á–∞—Ç —Å username
            chat_username = chat_username.replace('@MafiosoKG', '')  # –£–¥–∞–ª—è–µ–º @, –µ—Å–ª–∏ –µ—Å—Ç—å
            message_link = f"https://t.me/{chat_username}/{message_id}"
        else:  # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç (–µ—Å–ª–∏ username –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
            message_link = f"https://t.me/c/{abs(chat_id)}/{message_id}"

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞–Ω–∞–ª–∞
        report_message = ( 
            f"ü§ñ –ñ–∞–ª–æ–±–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è\n"
            f"‚ò†Ô∏è –û—Ç–ø—Ä–∞–≤–∏–ª(–∞): {sender_name} [{sender_id}]\n"
            f"üëø –ù–∞—Ä—É—à–∏–ª(–∞): {violator_name} [{violator_id}]\n"
            f"üóíÔ∏è –ü—Ä–∏—á–∏–Ω–∞: {violation_reason}\n"
            f"üñáÔ∏è –°—Å—ã–ª–∫–∞: {message_link}\n"
            f"üí¨ –ß–∞—Ç: {chat_username or '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç'} [{chat_id}]"
        )

        # –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
        markup = InlineKeyboardMarkup()
        approve_button = InlineKeyboardButton("üíö –û–î–û–ë–†–ò–¢–¨", callback_data="approve")
        reject_button = InlineKeyboardButton("‚ù§Ô∏è –û–¢–ö–õ–û–ù–ò–¢–¨", callback_data="reject")
        markup.add(approve_button, reject_button)

        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª —Å –∫–Ω–æ–ø–∫–∞–º–∏
        bot.send_message(CHANNEL_ID, report_message, reply_markup=markup)

        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        notification_message = (
            f"üóíÔ∏è –í–∞—à–∞ –∂–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –æ–∂–∏–¥–∞–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è.\n"
            f"üí¨ –ü—Ä–∏—á–∏–Ω–∞: {violation_reason}\n"
            f"üñáÔ∏è –°—Å—ã–ª–∫–∞: {message_link}"
        )
        bot.send_message(chat_id, notification_message, disable_web_page_preview=True)

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /report
@bot.message_handler(commands=['report'])
def handle_report(message):
    if not message.reply_to_message:
        # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —É–¥–∞–ª—è–µ–º –µ–µ
        try:
            bot.delete_message(chat_id=message.chat.id, message_id=message.message_id)
        except telebot.apihelper.ApiTelegramException as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π /report: {e}")
        return

    if len(message.text) <= len('/report '):
        bot.reply_to(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /report.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç—á–µ—Ç–∞
    sender_name = message.from_user.first_name  # –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∂–∞–ª–æ–±—ã
    sender_id = message.from_user.id            # ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∂–∞–ª–æ–±—ã
    violator_name = message.reply_to_message.from_user.first_name  # –ò–º—è –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è
    violator_id = message.reply_to_message.from_user.id            # ID –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è
    violation_reason = message.text[len('/report '):]  # –ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã (–≤—Å—ë, —á—Ç–æ –ø–æ—Å–ª–µ /report)
    chat_username = message.chat.username  # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–∞—Ç–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
    chat_id = message.chat.id          # ID —á–∞—Ç–∞
    message_id = message.reply_to_message.message_id  # ID —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∂–∞–ª–æ–±–∞

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∂–∞–ª–æ–±—ã –≤ –∫–∞–Ω–∞–ª
    send_violation_report(sender_id, sender_name, violator_id, violator_name, violation_reason, chat_username, chat_id, message_id)

    # –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–æ–º–∞–Ω–¥–æ–π /report
    try:
        bot.delete_message(chat_id=message.chat.id, message_id=message.message_id)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π /report: {e}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫
@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    try:
        if call.data in ["approve", "reject"]:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            status = "‚úÖ –û–î–û–ë–†–ï–ù–ê" if call.data == "approve" else "‚ùé –û–¢–ö–õ–û–ù–ï–ù–ê"
            
            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            bot.answer_callback_query(call.id, text=f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {status}")
            
            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            original_text = call.message.text
            lines = original_text.split("\n", 5)  # –†–∞–∑–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∫–∏
            if lines:
                lines[0] = f"ü§ñ –ñ–∞–ª–æ–±–∞ {status}"  # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç—É—Å–∞
            update_message = "\n".join(lines)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            if update_message != original_text:
                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–µ
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=update_message)

            # –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏: {e}")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.polling(none_stop=True)
